<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"lujianyun06.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="任务3. 在 Android 平台使用 Camera API 进行视频的采集，分别使用 SurfaceView、TextureView 来预览 Camera 数据，取到 NV21 的数据回调 由于这次的任务牵涉面十分广，所以用了很久才搞懂了一些知识，以后的任务也应该会做的越来越慢，不过十分合理，慢工出细活，上来一会儿就完成的东西，要不就是含金量不高，要不就是没有深究，对于学习阶段，虽然说有时候要管">
<meta property="og:type" content="article">
<meta property="og:title" content="Android 音视频任务3">
<meta property="og:url" content="https://lujianyun06.github.io/2020/04/10/Android/Android%20%E9%9F%B3%E8%A7%86%E9%A2%91%E4%BB%BB%E5%8A%A13/index.html">
<meta property="og:site_name" content="CloudLander&#39;s Blog">
<meta property="og:description" content="任务3. 在 Android 平台使用 Camera API 进行视频的采集，分别使用 SurfaceView、TextureView 来预览 Camera 数据，取到 NV21 的数据回调 由于这次的任务牵涉面十分广，所以用了很久才搞懂了一些知识，以后的任务也应该会做的越来越慢，不过十分合理，慢工出细活，上来一会儿就完成的东西，要不就是含金量不高，要不就是没有深究，对于学习阶段，虽然说有时候要管">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20181205184528266.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80Mzc1Mjg1NA==,size_16,color_FFFFFF,t_70">
<meta property="article:published_time" content="2020-04-10T07:44:11.000Z">
<meta property="article:modified_time" content="2020-04-10T08:04:48.802Z">
<meta property="article:author" content="CloudLander~Lu">
<meta property="article:tag" content="java">
<meta property="article:tag" content="后台开发">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://img-blog.csdnimg.cn/20181205184528266.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80Mzc1Mjg1NA==,size_16,color_FFFFFF,t_70">

<link rel="canonical" href="https://lujianyun06.github.io/2020/04/10/Android/Android%20%E9%9F%B3%E8%A7%86%E9%A2%91%E4%BB%BB%E5%8A%A13/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Android 音视频任务3 | CloudLander's Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">CloudLander's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">0</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">12</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">35</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://lujianyun06.github.io/2020/04/10/Android/Android%20%E9%9F%B3%E8%A7%86%E9%A2%91%E4%BB%BB%E5%8A%A13/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/lu.jpg">
      <meta itemprop="name" content="CloudLander~Lu">
      <meta itemprop="description" content="记录学习生活，力求每日进步">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CloudLander's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Android 音视频任务3
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2020-04-10 15:44:11 / 修改时间：16:04:48" itemprop="dateCreated datePublished" datetime="2020-04-10T15:44:11+08:00">2020-04-10</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>任务3. 在 Android 平台使用 Camera API 进行视频的采集，分别使用 SurfaceView、TextureView 来预览 Camera 数据，取到 NV21 的数据回调</p>
<p>由于这次的任务牵涉面十分广，所以用了很久才搞懂了一些知识，以后的任务也应该会做的越来越慢，不过十分合理，慢工出细活，上来一会儿就完成的东西，要不就是含金量不高，要不就是没有深究，对于学习阶段，虽然说有时候要管中窥豹不要太深究，但有些事情不搞清楚就不能算掌握知识了对吧？</p>
<p>下面是使用CameraAPI进行拍照和录视频，当然还有预览的全过程。虽然CameraAPI在5.0后就被弃用了（原因之一是它不能同时预览和拍摄），取而代之的是camera2，但由于众所周知的原因，仍然要好好学习。</p>
<p>添加权限后，如果是android6以上的，必须在设置的应用里面手动打开申请的权限</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.CAMERA"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-feature</span> <span class="attr">android:name</span>=<span class="string">"android.hardware.camera"</span> <span class="attr">android:required</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-feature</span> <span class="attr">android:name</span>=<span class="string">"android.hardware.camera.autofocus"</span> <span class="attr">android:required</span>=<span class="string">"false"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>相机的角度，如果不加调整的打开相机，默认的角度是0°，（这一点很奇怪。。）一般竖屏状态下是90度，横屏则为0或180度(应该是取决于传感器的方向)</p>
<h2 id="拍摄照片"><a href="#拍摄照片" class="headerlink" title="拍摄照片"></a>拍摄照片</h2><p>使用Camera拍摄照片的步骤：<br>要使用此类拍摄照片，请使用以下步骤：</p>
<ol>
<li>从open（int）获取Camera的实例。(首先使用以下方法获得设备摄像头数目)<br>int cameraNum = Camera.getNumberOfCameras();<br>//上面open的有效取值是 0 ~ cameraNum-1 代表了摄像头的设备id</li>
<li>使用getParameters（）获取现有（默认）设置。如有必要，修改返回的Camera.Parameters对象并调setParameters（Camera.Parameters）</li>
<li>调用setDisplayOrientation（int）以确保正确的预览方向。<br>  重要提示：将完全初始化的SurfaceHolder传递给    setPreviewDisplay（SurfaceHolder）。没有surface，相机将无法启动预览。<br> 重要说明：调用startPreview（）开始更新预览曲面。必须先开始预览才能拍照。</li>
<li>如果需要，可以调用takePicture（Camera.ShutterCallback，Camera.PictureCallback，Camera.PictureCallback，Camera.PictureCallback）来捕获照片。等待回调提供实际的图像数据。</li>
<li>拍照后，预览显示将停止。要拍摄更多照片，请先再次调用startPreview（）。</li>
<li>调用stopPreview（）以停止更新预览surface。<br>   重要提示：调用release（）以释放相机以供其他应用程序使用。应用程序应立即在Activity.onPause（）中释放相机（并在Activity.onResume（）中重新打开它）。</li>
</ol>
<p>一般自定义的来说，surface显示的图像都会被拉伸，或者压扁，反正就是图像比例不对，这是由于surfaceView和Camera.Size不匹配导致的，所以要根据surfaceView的宽高，在Camera所支持的Size里面找一个最合适的</p>
<p>在启用startPreview后，就可以通过Camera.takePicture()方法拍摄一张照片，返回的照片数据通过Callback接口获取。takePicture()接口可以获取三个类型的照片：</p>
<ul>
<li>第一个，ShutterCallback接口，在快门瞬间被回调，通常用于播放“咔嚓”这样的音效；</li>
<li>第二个，PictureCallback接口，返回未经压缩的RAW类型照片(字节数组)；</li>
<li>第三个，PictureCallback接口，返回经过压缩的JPEG类型照片(字节数组)；</li>
</ul>
<p>这三个都可以不实现，第一个一般没啥影响，但第二个第三个不实现则相当于拍的东西就没了。（第二第三个可以选一个实现）调用此方法后，在返回JPEG回调之前，不得调用startPreview（）或拍摄另一张照片。</p>
<p>camera.setDisplayOrientation(90); //设定的是预览的方向，预览和数据是独立的，如果只设置了DisplayOrientation，则在surfaceView中显示正常，但保存的数据仍然是0°的</p>
<p>修改拍摄数据角度的两种方法(以下均是竖屏情况，横屏情况不用额外处理，因为默认是横屏情况)：</p>
<ol>
<li>直接在设置camera参数的时候设置 parameters.setRotation(90); //这样拍摄出的data就是修正过后的数据，直接写到文件里即可<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPictureTaken</span><span class="params">(<span class="keyword">byte</span>[] data, Camera camera)</span> </span>&#123;</span><br><span class="line">    File file = <span class="keyword">new</span> File(fileName);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        FileOutputStream os = <span class="keyword">new</span> FileOutputStream(file);</span><br><span class="line">        os.write(data);</span><br><span class="line">        os.flush();</span><br><span class="line">        os.close();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mCamera != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mCamera.startPreview();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>不设置相机的Rotation，这样得到的数据是横屏情况下的，要使用Matrix和Bitmap进行修正<br>parameters.setPreviewFormat(ImageFormat.NV21); //默认预览帧格式为NV21,注意很多格式设备可能不支持，程序就会崩,如nexus6p不支持YUY2</li>
</ol>
<h2 id="录制视频"><a href="#录制视频" class="headerlink" title="录制视频"></a>录制视频</h2><h4 id="使用surfaceView"><a href="#使用surfaceView" class="headerlink" title="使用surfaceView"></a>使用surfaceView</h4><ol>
<li>像上面一样获得camera的实例并初始化它，并开启preview</li>
<li>调用unlock()允许mediaRecorder的工作线程使用设定好参数的camera</li>
<li>把camera实例传给MediaRecorder.setCamera(Camera) </li>
<li>设置用于预览的surface：MediaRecorder.setPreviewDisplay（如果camera没绑定surface，则此步骤会替换camera的surface为本参数）<br>//以下为设置录制的参数<br>设置视频源setVideoSource： 一般为摄像头<br>设置音频源setAudioSource:一般是CAMCORDER(单纯录视频是没声音的)  如果是用mediaRecorder单录音频的话，一般用MIC<br>设置输出文件格式：setOutputFormat<br>设置视频的角度：setOrientationHint //预览角度在camera的参数里设置<br>//下面的必须要放在输出格式确定后<br>设置视频编码：setVideoEncoder<br>设置音频编码:setAudioEncoder<br>//下面的必须要放在编码确定后<br>设置视频分辨率：setVideoSize; 这里的分辨率必须要选择设备摄像头支持的分辨率,否则报错(Camera.getParameters().getSupportedPreviewSizes()的值之一)<br>设置录制视频的捕获帧速率：setVideoFrameRate(); //必须要选择摄像头支持的帧率，否则报错（mCamera.getParameters().getSupportedPreviewFrameRates()的值之一）<br>设置所录制视频的编码位率:setVideoEncodingBitRate(3 * 1024 * 1024);<br>设置记录会话的最大持续时间(毫秒)setMaxDuration(30 * 1000);<br>设置输出文件的路径：setOutputFile</li>
<li>当完成录制后，调用camera.reconnect把camera的使用权从mediaRecorder的工作线程转回到设置了它的本线程</li>
<li>调用mediaRecorder调用stop和release 释放资源<br>一些总结性的概述：<br>surfaceView 只是一个用来占位置的控件，是用来显示surface内容的，它会显示它绑定的SurfaceHolder所持有的surface， 真正用于显示的是surface(它是具体的要显示的数据)，surface的持有者是SurfaceHolder，每个surfaceView生来就有一个默认与其绑定的SurfaceHolder，通过getHolder来获取，SurfaceHolder会决定如何去显示surface，每个surface有且只有一个SurfaceHolder，<br>surfaceView:画布<br>surface：画的内容<br>surfaceHolder，画内容的持有者<br>surfaceView、surfaceHolder、surface三位一体，是一个不可分的整体</li>
</ol>
<blockquote>
<p>一个camera设置好参数，它本身是被本线程持有的，持有的话是被lock的，mediaRecorder的工作是在单独的线程中完成的<br>使用setCamera给mediarecorder设置一个被设置好相机。而如果不调用setCamera设置相机的话，分配给的是一个默认情况下的相机，也就是说什么参数都没有被设置，这样一般不可能满足拍摄需求，因此一般要给mediaRecorder设置camera<br><br>在mediaRecorder.start之前，它的camera必须要调用unlock(如果设置了的话)，因为mediaRecorder的工作是在单独的线程中完成的，而camera默认是被创建它的线程所持有的，这样mediaRecorder的工作线程无法使用它)，如果start顺利结束，则会自动调用lock归还camera，如果start调用失败，则要手动lock来回收camera的所有权</p>
<p>mediaRecorder.setPreviewDisplay(Surface s)<br>给mediaRecorder设置surface，surface是用来显示mediaRecorder的相机的预览。如果s已经被一个设置给了camera（只是设置给了，还没有被持有资源），而且这个camera已经通过mediaRecorder.setCamera被设置给了mediaRecorder，那么这个方法不需要调用。如果s已经被设置给了一个另一个camera，只是设置给了，还没有被持有资源），但这个camera没有被设置给mediaRecorder，那么这个s将会被设置给给mediaRecorder自己的camera（如果没设置，则是默认的camera）。此时mediaRecorder自己的camera和另一个camera被设置了同一个surface.<br>如果s为空，则完全不会发生任何事</p>
<p><br>camera.setHolder<br>给camera设置一个holder，即surface；但此时holder的surface资源并不为camera所持有，只有当开启预览(即startPreview)时，surface资源才会被camera所持有（下面所说的surface和相应的surfaceHolder都是绑定的，彼此一体，surface资源也就相当于holder的资源）</p>
<p>如果对一个camera持有一个surface的资源，再次让另一个camera再次去持有这个surface资源，则会报错(mediaRecorder.start中会调用类似于它自己的camera.startPreview,startPreview会试图去占有surface资源)也就是说，同一个surfaceHolder可以被多个camera设置，但同时只能有一个camera持有它的surface的资源，否则就会报错。可以对同一个camera连续多次试图持有资源（反正资源就是你的，反复持有还是这些）.<br><br>当用startPreview成功开启预览后,surface的资源就被camera持有，此时单纯调用stopPreview关闭预览并不能释放它所持有的surface资源，必须要用camera.release(完全释放camera)，或者直接setDisplayHolder（null）（只释放camera占有的surface资源，不改变camera的其他参数设置）才能释放它占用的surface资源。但不能直接把camera置为null来释放资源，因为这样只能减少它的引用计数，不是真正的释放资源。</p>
</blockquote>
<p>mediaRecorder 不会吧自己的surface主动连接到自己设置的camera, 除非是不设置camera而使用默认的camera，因为mediaRecorder会默认自己设置的camera有surface</p>
<p>camera.setDisplayOrientation设置相机预览的角度，mediaRecorder.setOrientationHini设置存储的视频的角度，两者互相独立</p>
<h4 id="使用TextureView"><a href="#使用TextureView" class="headerlink" title="使用TextureView"></a>使用TextureView</h4><p>TextureViewView:<br>TextureView可用于显示内容流。 这样的内容流可以例如是视频或OpenGL场景。 内容流可以来自应用程序的进程以及远程进程。</p>
<p>TextureView只能在硬件加速窗口中使用。 在软件中渲染时，TextureView将不会绘制任何内容。(例如在xml中给textureView设置背景色，就直接会报错)</p>
<p>与SurfaceView不同，TextureView不会创建单独的窗口，而是表现为常规View。 这个关键区别允许它进行移动，转换，动画等。例如，您可以通过调用myView.setAlpha（0.5f）使TextureView半透明。</p>
<p>使用TextureView很简单：您需要做的就是获得它的SurfaceTexture。 然后，把SurfaceTexture用来呈现内容。 以下示例演示如何将相机预览渲染到TextureView中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LiveCameraActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> <span class="keyword">implements</span> <span class="title">TextureView</span>.<span class="title">SurfaceTextureListener</span> </span>&#123;</span><br><span class="line">      <span class="keyword">private</span> Camera mCamera;</span><br><span class="line">      <span class="keyword">private</span> TextureView mTextureView;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">          <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line"></span><br><span class="line">          mTextureView = <span class="keyword">new</span> TextureView(<span class="keyword">this</span>);</span><br><span class="line">          mTextureView.setSurfaceTextureListener(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">          setContentView(mTextureView);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSurfaceTextureAvailable</span><span class="params">(SurfaceTexture surface, <span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</span><br><span class="line">          mCamera = Camera.open();</span><br><span class="line"></span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">              mCamera.setPreviewTexture(surface);</span><br><span class="line">              mCamera.startPreview();</span><br><span class="line">          &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">              <span class="comment">// Something bad happened</span></span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSurfaceTextureSizeChanged</span><span class="params">(SurfaceTexture surface, <span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</span><br><span class="line">          <span class="comment">// Ignored, Camera does all the work for us</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onSurfaceTextureDestroyed</span><span class="params">(SurfaceTexture surface)</span> </span>&#123;</span><br><span class="line">          mCamera.stopPreview();</span><br><span class="line">          mCamera.release();</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSurfaceTextureUpdated</span><span class="params">(SurfaceTexture surface)</span> </span>&#123;</span><br><span class="line">          <span class="comment">// Invoked every time there's a new Camera preview frame</span></span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>可以通过调用getSurfaceTexture（）或使用TextureView.SurfaceTextureListener来获取TextureView的SurfaceTexture。 重要的是要知道只有在将TextureView附加到窗口（并且已调用onAttachedToWindow（）之后）才能使用SurfaceTexture。因此，强烈建议您使用listener在SurfaceTexture可用时进行通知。</p>
<p>值得注意的是，只有一个生产者可以使用TextureView。 例如，如果使用TextureView显示相机预览，则无法使用lockCanvas（）同时绘制到TextureView。<br>如同surface一样，TextureView的surfaceTexture资源同一时间也只能被一个对象所持有</p>
<p>———————————————————————————————————————————————————————————————<br>SurfaceTexture:<br>从图像流中捕获帧作为OpenGL ES纹理。</p>
<p>图像流可以来自相机预览或视频解码。从SurfaceTexture创建的Surface可以用作android.hardware.camera2，MediaCodec，MediaPlayer和Allocation API的输出目标。调用updateTexImage（）时，将更新创建SurfaceTexture时指定的纹理对象的内容，以包含图像流中的最新图像。这可能导致跳过一些流的帧。</p>
<p>在指定旧版Camera API的输出目标时，也可以使用SurfaceTexture代替SurfaceHolder。这样做会导致图像流中的所有帧都被发送到SurfaceTexture对象而不是设备的显示。</p>
<p>从纹理中采样时，应首先使用通过getTransformMatrix（float []）查询的矩阵变换纹理坐标。每次调用updateTexImage（）时变换矩阵都会改变，因此每次更新纹理图像时都应该重新查询。该矩阵将形式为（s，t，0,1）的传统2D OpenGL ES纹理坐标列向量转换为包含区间[0,1]上的s和t到流式纹理中的适当采样位置。此变换可补偿图像流源的任何属性，使其看起来与传统的OpenGL ES纹理不同。例如，可以通过使用查询的矩阵变换列向量（0,0,0,1）来完成从图像左下角的采样，而从图像的右上角进行采样可以通过变换来完成（ 1,1,0,1）。</p>
<p>纹理对象使用GL_TEXTURE_EXTERNAL_OES纹理目标，该目标由GL_OES_EGL_image_external OpenGL ES扩展定义。这限制了纹理的使用方式。每次绑定纹理时，它必须绑定到GL_TEXTURE_EXTERNAL_OES目标而不是GL_TEXTURE_2D目标。此外，从纹理中采样的任何OpenGL ES 2.0着色器必须使用例如“#extension GL_OES_EGL_image_external：require”指令声明其对此扩展的使用。此类着色器还必须使用samplerExternalOES GLSL采样器类型访问纹理。</p>
<p>可以在任何线程上创建SurfaceTexture对象。 updateTexImage（）只能在包含纹理对象的OpenGL ES上下文的线程上调用。在任意线程上调用可用帧的回调，因此除非特别小心，否则不应直接从回调中调用updateTexImage（）。<br>———————————————————————————————————————————————————————————————</p>
<p>录制流程：<br>其他步骤均和surfaceView一样，只有第四步有区别,由于此时不能获得surfaceHolder，只要把TextureView的SurfaceTexture绑定到相机即可（给camera设置用于预览的surfaceTexture：camera.setPreviewTexture（代替camera.setPreviewDisplay)，同时而且也不需要给mediaRecorder调用setPreviewDisplay）</p>
<p>MediaRecorder：用来录制音频和视频，录制控制基于简单的状态机，如下图：<br><img src="https://img-blog.csdnimg.cn/20181205184528266.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80Mzc1Mjg1NA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>使用MediaRecorder录制<strong>音频</strong>的流程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">A common <span class="keyword">case</span> of using MediaRecorder to record audio works as follows:</span><br><span class="line">MediaRecorder recorder = <span class="keyword">new</span> MediaRecorder();</span><br><span class="line"> recorder.setAudioSource(MediaRecorder.AudioSource.MIC);</span><br><span class="line"> recorder.setOutputFormat(MediaRecorder.OutputFormat.THREE_GPP);</span><br><span class="line"> recorder.setAudioEncoder(MediaRecorder.AudioEncoder.AMR_NB);</span><br><span class="line"> recorder.setOutputFile(PATH_NAME);</span><br><span class="line"> recorder.prepare();</span><br><span class="line"> recorder.start();   <span class="comment">// Recording is now started</span></span><br><span class="line"> ...</span><br><span class="line"> recorder.stop();</span><br><span class="line"> recorder.reset();   <span class="comment">// You can reuse the object by going back to setAudioSource() step</span></span><br><span class="line"> recorder.release(); <span class="comment">// Now the object cannot be reused</span></span><br></pre></td></tr></table></figure>
<p>//这个不需要手动另开线程写数据，体积小使用方便，但很大的一个缺点就是录下的音质不太好。相比之下AudioRecord虽然麻烦一点，但录制的更像是无损音质</p>
<p>application可能希望注册信息和错误事件，以便在录制期间获知某些内部更新和可能的运行时错误。 通过设置适当的监听器（通过调用（到setOnInfoListener（OnInfoListener）setOnInfoListener和/或setOnErrorListener（OnErrorListener）setOnErrorListener）来注册此类事件。为了接收与这些侦听器关联的相应回调，应用程序需要在运行Looper的线程上创建MediaRecorder对象 （默认情况下，主UI线程已经运行了Looper）。</p>
<figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">使用MediaRecorder报错at android.media.MediaRecorder.start(Native <span class="function"><span class="keyword">Method</span>)：很可能是如下原因:</span> </span><br><span class="line"><span class="number">1</span>.使用下面两个函数但参数不被当前硬件所支持</span><br><span class="line">mediaRecorder.setVideoFrameRate()和mediaRecorder.setVideoSize(videoWidth, videoHeight)</span><br><span class="line"><span class="comment">//注释掉后，会使用硬件支持的默认的参数，就不会出错了,</span></span><br><span class="line">要获得硬件支持的参数用如下的函数：</span><br><span class="line">mCamera.getParameters().getSupportedPreviewSizes()的值之一</span><br><span class="line">mCamera.getParameters().getSupportedPreviewFrameRates()的值之一</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>.已经有其他摄像头开启过预览，持有了SurfaceView或SurfaceTexture的surface资源，但停止预览后没有释放资源</span><br><span class="line"></span><br><span class="line">另：mediaRecorder.setVideoSize不能设置的太大，否则点击录像后画面会停住</span><br></pre></td></tr></table></figure>
<h5 id="相机预览数据的获取"><a href="#相机预览数据的获取" class="headerlink" title="相机预览数据的获取"></a>相机预览数据的获取</h5><p>转自：<a href="https://blog.csdn.net/lb377463323/article/details/53338045" target="_blank" rel="noopener">https://blog.csdn.net/lb377463323/article/details/53338045</a><br>首先定义一个类实现Camera.PreviewCallback接口，然后在它的onPreviewFrame(byte[] data, Camera camera)方法中即可接收到每一帧的预览数据，也就是参数data。<br>然后使用setPreviewCallback()、setOneShotPreviewCallback或setPreviewCallbackWithBuffer()注册回调接口，下面介绍一下这些方法： </p>
<pre><code>1，void setPreviewCallback (Camera.PreviewCallback cb) </code></pre><p>一旦使用此方法注册预览回调接口，onPreviewFrame()方法会一直被调用，直到camera preview销毁</p>
<p>注意，onPreviewFrame()方法跟Camera.open()是运行于同一个线程，所以为了防止onPreviewFrame()会阻塞UI线程，将Camera.open()放置在子线程中运行。</p>
<pre><code>2，void setOneShotPreviewCallback (Camera.PreviewCallback cb) </code></pre><p>使用此方法注册预览回调接口时，会将下一帧数据回调给onPreviewFrame()方法，调用完成后这个回调接口将被销毁。也就是只会回调一次预览帧数据。</p>
<pre><code>3，void setPreviewCallbackWithBuffer (Camera.PreviewCallback cb) </code></pre><p>它跟setPreviewCallback的工作方式一样，但是要求指定一个字节数组作为缓冲区，用于预览帧数据，这样能够更好的管理预览帧数据时使用的内存。它一般搭配addCallbackBuffer方法使用，伪代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">byte</span>[] mPreBuffer = <span class="keyword">new</span> <span class="keyword">byte</span>[size];<span class="comment">//首先分配一块内存作为缓冲区，size的计算方式见第四点中</span></span><br><span class="line">mCamera.addCallbackBuffer(mPreBuffer);</span><br><span class="line">mCamera.setPreviewCallbackWithBuffer(Camera.PreviewCallback cb);</span><br><span class="line">mCamera.startPreview();</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPreviewFrame</span><span class="params">(<span class="keyword">byte</span>[] data, Camera camera)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mPreBuffer == <span class="keyword">null</span>) &#123;</span><br><span class="line">        mPreBuffer = <span class="keyword">new</span> <span class="keyword">byte</span>[size];</span><br><span class="line">    &#125;</span><br><span class="line">    mCamera.addCallbackBuffer(mPreBuffer);<span class="comment">//将此缓冲区添加到预览回调缓冲区队列中</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>setPreviewCallbackWithBuffer需要在startPreview()之前调用，因为setPreviewCallbackWithBuffer使用时需要指定一个字节数组作为缓冲区，用于预览帧数据，所以我们需要在setPreviewCallbackWithBuffer之前调用addCallbackBuffer，这样onPreviewFrame的data才有值。</p>
<p>总结一下，设置addCallbackBuffer的地方有两个，一个是在startPreview之前，一个是在onPreviewFrame中，这两个都需要调用，如果在onPreviewFrame中不调用，那么预览帧数据就不会回调给onPreviewFrame了</p>
<pre><code>4，void addCallbackBuffer (byte[] callbackBuffer) </code></pre><p>添加一个预分配的缓冲区到预览回调缓冲区队列中。应用程序可一添加一个或多个缓冲器到这个队列中。当预览帧数据到达时并且缓冲区队列仍然有至少一个可用的缓冲区时，这个 缓冲区将会被消耗掉然后从队列中移除，然后这个缓冲区会调用预览回调接口。如果预览帧数据到达时没有剩余的缓冲区，这帧数据将会被丢弃。当缓冲区中的数据处理完成后，应用程序应该将这个缓冲区添加回缓冲区队列中。<br>对于非YV12的格式，缓冲区的Size是预览图像的宽、高和每个像素的字节数的乘积。宽高可以使用getPreviewSize()方法获取。每个像素的字节数可以使用ImageFormat.getBitsPerPixel(mCameraParameters.getPreviewFormat()) / 8获取。<br>对于YU12的格式，缓冲区的Size可以使用setPreviewFormat(int)里面的公式计算，具体详见官方文档。<br>这个方法只有在使用setPreviewCallbackWithBuffer(PreviewCallback)时才有必要使用。当使用setPreviewCallback(PreviewCallback) 或者setOneShotPreviewCallback(PreviewCallback)时，缓冲区会自动分配。当提供的缓冲区如果太小了，不能支持预览帧数据时，预览回调接口将会return null，然后从缓冲区队列中移除此缓冲区。</p>
<p>完整代码：只需在activity里面调用runTask3即可</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.app.Activity;</span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Bitmap;</span><br><span class="line"><span class="keyword">import</span> android.graphics.BitmapFactory;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Matrix;</span><br><span class="line"><span class="keyword">import</span> android.graphics.SurfaceTexture;</span><br><span class="line"><span class="keyword">import</span> android.hardware.Camera;</span><br><span class="line"><span class="keyword">import</span> android.media.MediaRecorder;</span><br><span class="line"><span class="keyword">import</span> android.os.AsyncTask;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.os.Environment;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> android.view.SurfaceHolder;</span><br><span class="line"><span class="keyword">import</span> android.view.SurfaceView;</span><br><span class="line"><span class="keyword">import</span> android.view.TextureView;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.widget.Button;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.lll.va.R;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Task3</span> <span class="keyword">implements</span> <span class="title">View</span>.<span class="title">OnClickListener</span>,</span></span><br><span class="line"><span class="class">        <span class="title">TextureView</span>.<span class="title">SurfaceTextureListener</span>,</span></span><br><span class="line"><span class="class">        <span class="title">SurfaceHolder</span>.<span class="title">Callback</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String tag = Task3<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>()</span>;</span><br><span class="line">    <span class="keyword">private</span> Camera mCamera;</span><br><span class="line">    <span class="keyword">private</span> SurfaceHolder mHolder;</span><br><span class="line">    <span class="keyword">private</span> CameraUtil mCameraUtil;</span><br><span class="line">    <span class="keyword">private</span> Context mContext;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> height;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> width;</span><br><span class="line">    <span class="keyword">private</span> SurfaceView surfaceView;</span><br><span class="line">    <span class="keyword">private</span> TextureView textureView;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Task3 task3;</span><br><span class="line">    <span class="keyword">private</span> Activity mActivity;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> isSurfaceMode;  <span class="comment">//切换surfaceview和textureview的演示</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> String videoFileName = Environment.getExternalStorageDirectory() + <span class="string">"/test_vedio.mp4"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">runTask3</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">        task3 = <span class="keyword">new</span> Task3(activity);</span><br><span class="line">        task3.initView();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Task3</span><span class="params">(Activity activity)</span> </span>&#123;</span><br><span class="line">        mActivity = activity;</span><br><span class="line">        mContext = activity;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mActivity.setContentView(R.layout.activity_task3);</span><br><span class="line"></span><br><span class="line">        surfaceView = mActivity.findViewById(R.id.sv_t3);</span><br><span class="line">        textureView = mActivity.findViewById(R.id.texture_view_1);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//为了知道surface的生命周期，一般只有surface建好后才开始下一步动作</span></span><br><span class="line">        <span class="comment">//surfaceView必须给holder添加callback，TextureView必须给自己添加listener</span></span><br><span class="line">        <span class="keyword">if</span> (surfaceView.getVisibility() == View.VISIBLE) &#123;</span><br><span class="line">            isSurfaceMode = <span class="keyword">true</span>;</span><br><span class="line">            surfaceView.getHolder().addCallback(<span class="keyword">this</span>);</span><br><span class="line">            mHolder = surfaceView.getHolder();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            isSurfaceMode = <span class="keyword">false</span>;</span><br><span class="line">            textureView.setSurfaceTextureListener(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Button btnTakePic = mActivity.findViewById(R.id.btn_take_pic);</span><br><span class="line">        Button btnStartVideo = mActivity.findViewById(R.id.btn_start_video);</span><br><span class="line">        Button btnStopVideo = mActivity.findViewById(R.id.btn_stop_video);</span><br><span class="line">        btnTakePic.setOnClickListener(<span class="keyword">this</span>);</span><br><span class="line">        btnStartVideo.setOnClickListener(<span class="keyword">this</span>);</span><br><span class="line">        btnStopVideo.setOnClickListener(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">getWidthAndHeight</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        width = isSurfaceMode ? surfaceView.getWidth() : textureView.getWidth();</span><br><span class="line">        height = isSurfaceMode ? surfaceView.getHeight() : textureView.getHeight();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initCamera</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mCamera != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mCamera.release();</span><br><span class="line">            mCamera = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Log.d(tag, <span class="string">"is surfaceview = "</span> + isSurfaceMode);</span><br><span class="line">        mCameraUtil = CameraUtil.getInstance();</span><br><span class="line">        mCamera = mCameraUtil.openCamera(<span class="number">0</span>);</span><br><span class="line">        Bundle paramBundle = <span class="keyword">new</span> Bundle();  <span class="comment">//感觉干脆用bundle传参好了</span></span><br><span class="line">        getWidthAndHeight();</span><br><span class="line">        paramBundle.putInt(<span class="string">"width"</span>, width);</span><br><span class="line">        paramBundle.putInt(<span class="string">"height"</span>, height);</span><br><span class="line">        mCameraUtil.setCameraParamter(mContext, mCamera, paramBundle);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//根据不同的view，选择不同的预览载体</span></span><br><span class="line">        <span class="keyword">if</span> (isSurfaceMode) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">                mCamera.setPreviewDisplay(surfaceView.getHolder());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                mCamera.setPreviewTexture(textureView.getSurfaceTexture());</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//预览监听</span></span><br><span class="line">        mCamera.setPreviewCallback(mCameraCallback);</span><br><span class="line"><span class="comment">//        mCamera.setPreviewCallbackWithBuffer(mCameraCallback);</span></span><br><span class="line">        <span class="comment">//开始预览</span></span><br><span class="line">        mCamera.startPreview();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**************************  录视频部分   *******************************/</span></span><br><span class="line">    MediaRecorder mediaRecorder;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startVideoRecord</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        mediaRecorder = <span class="keyword">new</span> MediaRecorder();<span class="comment">// 创建mediarecorder对象</span></span><br><span class="line">        <span class="comment">// 设置录制视频源为设置好参数的Camera(相机)</span></span><br><span class="line">        mediaRecorder.setOnInfoListener(mediaCallbackListener);</span><br><span class="line">        mediaRecorder.setOnErrorListener(mediaCallbackListener);</span><br><span class="line">        mCamera.unlock();</span><br><span class="line"></span><br><span class="line">        mediaRecorder.setCamera(mCamera);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (isSurfaceMode)<span class="comment">//如果给camera设置了setPreviewDisplay，则这句可以不加</span></span><br><span class="line">            mediaRecorder.setPreviewDisplay(mHolder.getSurface());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Log.d(tag, <span class="string">"camera + "</span> + mCamera);</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">        mediaRecorder.setVideoSource(MediaRecorder.VideoSource.CAMERA);</span><br><span class="line">        mediaRecorder.setAudioSource(MediaRecorder.AudioSource.CAMCORDER);</span><br><span class="line">        <span class="comment">// 设置录制完成后视频的封装格式THREE_GPP为3gp.MPEG_4为mp4</span></span><br><span class="line">        mediaRecorder</span><br><span class="line">                .setOutputFormat(MediaRecorder.OutputFormat.MPEG_4);</span><br><span class="line">        <span class="comment">// 设置录制的视频编码h264</span></span><br><span class="line">        <span class="comment">//音频编码为AAC</span></span><br><span class="line">        mediaRecorder.setVideoEncoder(MediaRecorder.VideoEncoder.H264);</span><br><span class="line">        mediaRecorder.setAudioEncoder(MediaRecorder.AudioEncoder.AAC);</span><br><span class="line">        mediaRecorder.setOrientationHint(<span class="number">90</span>);</span><br><span class="line">        <span class="comment">// 设置视频录制的分辨率。必须放在设置编码和格式的后面，否则报错</span></span><br><span class="line">        mediaRecorder.setVideoSize(<span class="number">1600</span>, <span class="number">1200</span>);</span><br><span class="line">        mediaRecorder.setVideoEncodingBitRate(<span class="number">1024</span> * <span class="number">1024</span> * <span class="number">5</span>);<span class="comment">// 设置编码位率,图像模糊的设置了这个图像就清晰了</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置录制的视频帧率。必须放在设置编码和格式的后面，否则报错</span></span><br><span class="line">        mediaRecorder.setVideoFrameRate(<span class="number">24</span>);</span><br><span class="line"><span class="comment">//        mediaRecorder.setPreviewDisplay(mHolder.getSurface());</span></span><br><span class="line">        <span class="comment">// 设置视频文件输出的路径</span></span><br><span class="line">        mediaRecorder.setOutputFile(Task3.videoFileName);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 准备录制</span></span><br><span class="line">            mediaRecorder.prepare();</span><br><span class="line">            <span class="comment">// 开始录制</span></span><br><span class="line">            mediaRecorder.start();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalStateException e) &#123;</span><br><span class="line">            <span class="comment">// TODO Auto-generated catch block</span></span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="comment">// TODO Auto-generated catch block</span></span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stopVideoRecord</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mediaRecorder == <span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line">        mediaRecorder.stop();</span><br><span class="line">        mediaRecorder.release();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mCamera.lock();</span><br><span class="line">            mCamera.reconnect();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//这或许是camera的bug，预览的时候不能同时进行拍摄，如果拍摄结束后还需要预览</span></span><br><span class="line">            <span class="comment">//要再setPreviewCallback和startPreview，貌似在camera2中解决了</span></span><br><span class="line">            mCamera.setPreviewCallback(mCameraCallback);</span><br><span class="line">            mCamera.startPreview();</span><br><span class="line"><span class="comment">//            mCamera.lock();</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> CameraCallback mCameraCallback = <span class="keyword">new</span> CameraCallback();</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">CameraCallback</span> <span class="keyword">implements</span> <span class="title">Camera</span>.<span class="title">PreviewCallback</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPreviewFrame</span><span class="params">(<span class="keyword">byte</span>[] data, Camera camera)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">int</span> len = data.length;</span><br><span class="line">            <span class="comment">//当相机的预览分辨率为1600 * 1200，预览图像的编码格式为 NV21 即 12bit/pixel 时</span></span><br><span class="line">            <span class="comment">//每一帧图像的大小应该为 1600 * 1200 * 12 / 8 = 2880000 Bytes</span></span><br><span class="line">            Log.d(tag, <span class="string">"onPreviewFrame data.data len="</span> + len);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    MediaCallbackListener mediaCallbackListener;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/************************  SurfaceTextureListener  **********************************/</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSurfaceTextureAvailable</span><span class="params">(SurfaceTexture surface, <span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!isSurfaceMode)</span><br><span class="line">            initCamera();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSurfaceTextureSizeChanged</span><span class="params">(SurfaceTexture surface, <span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onSurfaceTextureDestroyed</span><span class="params">(SurfaceTexture surface)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSurfaceTextureUpdated</span><span class="params">(SurfaceTexture surface)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/************************  SurfaceCallback  **********************************/</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">surfaceCreated</span><span class="params">(SurfaceHolder holder)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (isSurfaceMode)</span><br><span class="line">            initCamera();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">surfaceChanged</span><span class="params">(SurfaceHolder holder, <span class="keyword">int</span> format, <span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">surfaceDestroyed</span><span class="params">(SurfaceHolder holder)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**********************************************************/</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">MediaCallbackListener</span> <span class="keyword">implements</span> <span class="title">MediaRecorder</span>.<span class="title">OnInfoListener</span>, <span class="title">MediaRecorder</span>.<span class="title">OnErrorListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(MediaRecorder mr, <span class="keyword">int</span> what, <span class="keyword">int</span> extra)</span> </span>&#123;</span><br><span class="line">            Log.d(tag, <span class="string">"error"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onInfo</span><span class="params">(MediaRecorder mr, <span class="keyword">int</span> what, <span class="keyword">int</span> extra)</span> </span>&#123;</span><br><span class="line">            Log.d(tag, <span class="string">"info"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line"><span class="comment">//        if (mCamera == null) return;</span></span><br><span class="line">        <span class="keyword">if</span> (v.getId() == R.id.btn_take_pic) <span class="comment">//拍照</span></span><br><span class="line">            takePicture();</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (v.getId() == R.id.btn_start_video)</span><br><span class="line">            startVideoRecord();</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (v.getId() == R.id.btn_stop_video)</span><br><span class="line">            stopVideoRecord();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**************************  拍照部分   *******************************/</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">takePicture</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mCamera.takePicture(<span class="keyword">null</span>, <span class="keyword">null</span>, mPictureCallback);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    String fileName = Environment.getExternalStorageDirectory() + <span class="string">"/t3.jpg"</span>;</span><br><span class="line">    <span class="keyword">private</span> Camera.PictureCallback mPictureCallback = <span class="keyword">new</span> Camera.PictureCallback() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPictureTaken</span><span class="params">(<span class="keyword">byte</span>[] data, Camera camera)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            SavePicAsyncTask saveBitmapTask = <span class="keyword">new</span> SavePicAsyncTask();</span><br><span class="line">            saveBitmapTask.execute(data);</span><br><span class="line">            Thread t = <span class="keyword">new</span> Thread();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mCamera != <span class="keyword">null</span>) &#123;</span><br><span class="line">                mCamera.startPreview();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Camera.ShutterCallback mShutterCallback = <span class="keyword">new</span> Camera.ShutterCallback() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onShutter</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//这是设置了rotation时调用保存图片的方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">savePic</span><span class="params">(<span class="keyword">byte</span>[] data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            File file = <span class="keyword">new</span> File(fileName);</span><br><span class="line">            FileOutputStream os = <span class="keyword">new</span> FileOutputStream(file);</span><br><span class="line">            os.write(data);</span><br><span class="line">            os.flush();</span><br><span class="line">            os.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mCamera != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mCamera.startPreview();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//使用bitmap保存时，因为compress是耗时方法，放在onPictureTaken中会体验极差，所以放个后台任务来压缩保存图片</span></span><br><span class="line">    <span class="keyword">private</span>  <span class="class"><span class="keyword">class</span> <span class="title">SavePicAsyncTask</span> <span class="keyword">extends</span> <span class="title">AsyncTask</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> Object <span class="title">doInBackground</span><span class="params">(Object[] objects)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">byte</span>[] data = (<span class="keyword">byte</span>[]) objects[<span class="number">0</span>];</span><br><span class="line">            Bitmap bm0 = BitmapFactory.decodeByteArray(data, <span class="number">0</span>, data.length);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//由于camera.</span></span><br><span class="line">            Matrix m = <span class="keyword">new</span> Matrix();</span><br><span class="line">            m.setRotate(<span class="number">90</span>, (<span class="keyword">float</span>) bm0.getWidth() / <span class="number">2</span>, (<span class="keyword">float</span>) bm0.getHeight() / <span class="number">2</span>); <span class="comment">//后面两个是旋转轴心坐标</span></span><br><span class="line">            Bitmap bitmap = Bitmap.createBitmap(bm0, <span class="number">0</span>, <span class="number">0</span>, bm0.getWidth(), bm0.getHeight(), m, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">            File file = <span class="keyword">new</span> File(fileName);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                FileOutputStream os = <span class="keyword">new</span> FileOutputStream(file);</span><br><span class="line">                bitmap.compress(Bitmap.CompressFormat.JPEG, <span class="number">85</span>, os);</span><br><span class="line">                os.flush();</span><br><span class="line">                os.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>CameraUtil</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.content.res.Configuration;</span><br><span class="line"><span class="keyword">import</span> android.graphics.ImageFormat;</span><br><span class="line"><span class="keyword">import</span> android.hardware.Camera;</span><br><span class="line"><span class="keyword">import</span> android.media.Image;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.security.PublicKey;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CameraUtil</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String tag = CameraUtil<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>()</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> CameraUtil util;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> CameraUtil <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (util == <span class="keyword">null</span>) &#123;</span><br><span class="line">            util = <span class="keyword">new</span> CameraUtil();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> util;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> CameraNum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">boolean</span> mIsPortrait = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">CameraUtil</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        CameraNum = Camera.getNumberOfCameras();</span><br><span class="line">        Log.d(tag, <span class="string">"cam_num="</span> + CameraNum);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Camera <span class="title">openCamera</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (CameraNum == <span class="number">0</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        Camera camera = Camera.open(id); <span class="comment">//打开第一个摄像头</span></span><br><span class="line">        <span class="keyword">return</span> camera;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCameraParamter</span><span class="params">(Context context, Camera camera, Bundle paramBundle)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (camera == <span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        Camera.Parameters parameters = camera.getParameters();</span><br><span class="line">        parameters.setFlashMode(Camera.Parameters.FLASH_MODE_AUTO); <span class="comment">//闪光灯模式</span></span><br><span class="line">        parameters.setFocusMode(Camera.Parameters.FOCUS_MODE_CONTINUOUS_VIDEO);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> width = paramBundle.getInt(<span class="string">"width"</span>);</span><br><span class="line">        <span class="keyword">int</span> height = paramBundle.getInt(<span class="string">"height"</span>);</span><br><span class="line">        Log.d(tag, <span class="string">"width = "</span> + width + <span class="string">" height ="</span> + height);</span><br><span class="line">        List&lt;Camera.Size&gt; sizeList = parameters.getSupportedPreviewSizes();</span><br><span class="line">        Camera.Size lastSize = getOptimalPreviewSize(context, sizeList, width, height);</span><br><span class="line">        parameters.setPreviewSize(lastSize.width, lastSize.height);</span><br><span class="line">        Log.d(tag, <span class="string">"surwidth = "</span> + width + <span class="string">" surheight ="</span> + height</span><br><span class="line">                + <span class="string">" size width="</span> + lastSize.width + <span class="string">" size height="</span> + lastSize.height);</span><br><span class="line">        parameters.setPreviewFormat(ImageFormat.NV21); <span class="comment">//默认预览帧格式</span></span><br><span class="line">        <span class="comment">//拍照分辨率和预览分辨率</span></span><br><span class="line"><span class="comment">//        parameters.setPictureSize();</span></span><br><span class="line"><span class="comment">//        parameters.setPreviewSize(); //预览分辨率只能从上面的sizeList里面选取</span></span><br><span class="line"></span><br><span class="line">        followScreenOrientation(context, camera);</span><br><span class="line">        camera.setParameters(parameters);</span><br><span class="line">        <span class="comment">//有的手机这么设置会出错，则使用camera.getParameters().setFlashMode(Camera.Parameters.FLASH_MODE_AUTO);的形式设置</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">followScreenOrientation</span><span class="params">(Context context, Camera camera)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> orientation = context.getResources().getConfiguration().orientation;</span><br><span class="line">        <span class="keyword">if</span> (orientation == Configuration.ORIENTATION_LANDSCAPE) &#123;</span><br><span class="line">            camera.setDisplayOrientation(<span class="number">180</span>);</span><br><span class="line">            mIsPortrait = <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (orientation == Configuration.ORIENTATION_PORTRAIT) &#123;</span><br><span class="line">            camera.setDisplayOrientation(<span class="number">90</span>);</span><br><span class="line">            mIsPortrait = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//虽然这样画面还是有一点点扁，还是不知道系统相机是如何做到画面不扁而且还像素高的</span></span><br><span class="line">    <span class="keyword">private</span> Camera.<span class="function">Size <span class="title">getOptimalPreviewSize</span><span class="params">(Context context, List&lt;Camera.Size&gt; sizes, <span class="keyword">int</span> w, <span class="keyword">int</span> h)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">double</span> ASPECT_TOLERANCE = <span class="number">0.2</span>;  <span class="comment">//camera宽高比与surface宽高比的最大误差阈值,越小越精确，但可能没有合适的分辨率，一般为0.1或0.2</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> orientation = context.getResources().getConfiguration().orientation;</span><br><span class="line">        <span class="keyword">int</span> targetHeight = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">double</span> targetRatio = <span class="number">0</span>d;</span><br><span class="line">        <span class="comment">//由于横竖屏不一样，系统相机的尺寸默认是横屏状态下的，</span></span><br><span class="line">        <span class="comment">// 所以竖屏状态下，比例就是高宽比（因此此时高大于宽），而与系统中高度比较时则应该用宽(哪个小用哪个)</span></span><br><span class="line">        <span class="keyword">if</span> (orientation == Configuration.ORIENTATION_LANDSCAPE) &#123;</span><br><span class="line">            targetRatio = (<span class="keyword">double</span>) w / h;</span><br><span class="line">            targetHeight = h;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (orientation == Configuration.ORIENTATION_PORTRAIT) &#123;</span><br><span class="line">            targetRatio = (<span class="keyword">double</span>) h / w;</span><br><span class="line">            targetHeight = w;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//获得surfaceView的宽高比</span></span><br><span class="line">        <span class="keyword">if</span> (sizes == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        Camera.Size optimalSize = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">double</span> minDiff = Double.MAX_VALUE; <span class="comment">//在比例合适的情况下，两种高度最低能达到的差值（肯定是越小越符合），一开始设为最大浮点数</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Log.d(tag, <span class="string">"targetHeight="</span> + targetHeight);</span><br><span class="line">        <span class="comment">// Try to find an size match aspect ratio and size</span></span><br><span class="line">        <span class="keyword">for</span> (Camera.Size size : sizes) &#123;  <span class="comment">//遍历当前摄像头支持的分辨率，并计算宽高比</span></span><br><span class="line">            <span class="keyword">double</span> ratio = (<span class="keyword">double</span>) size.width / size.height;</span><br><span class="line">            Log.d(tag, <span class="string">"width="</span> + size.width + <span class="string">" height="</span> + size.height);</span><br><span class="line">            Log.d(tag, <span class="string">"target Ratio="</span> + targetRatio + <span class="string">" ratio="</span> + ratio);</span><br><span class="line">            <span class="keyword">if</span> (Math.abs(ratio - targetRatio) &gt; ASPECT_TOLERANCE) <span class="keyword">continue</span>; <span class="comment">//如果两个宽高比之差大于阈值，不符合</span></span><br><span class="line">            <span class="keyword">if</span> (Math.abs(size.height - targetHeight) &lt; minDiff) &#123; <span class="comment">//找到了更小的差值，则替换最合适的比例</span></span><br><span class="line">                optimalSize = size;</span><br><span class="line">                minDiff = Math.abs(size.height - targetHeight);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//         Cannot find the one match the aspect ratio, ignore the requirement</span></span><br><span class="line">        <span class="keyword">if</span> (optimalSize == <span class="keyword">null</span>) &#123;          <span class="comment">//当使用阈值找不到时，则忽略比例阈值，直接用最小的高度差的那组分辨率</span></span><br><span class="line">            minDiff = Double.MAX_VALUE;</span><br><span class="line">            <span class="keyword">for</span> (Camera.Size size : sizes) &#123;</span><br><span class="line">                <span class="keyword">if</span> (Math.abs(size.height - targetHeight) &lt; minDiff) &#123;</span><br><span class="line">                    optimalSize = size;</span><br><span class="line">                    minDiff = Math.abs(size.height - targetHeight);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> optimalSize;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>布局文件，只让surfaceview和textureview其中之一显示</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:orientation</span>=<span class="string">"vertical"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--surfaceView 和 TextureView选一个隐藏 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">SurfaceView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/sv_t3"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:visibility</span>=<span class="string">"visible"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"500dp"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">TextureView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/texture_view_1"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:visibility</span>=<span class="string">"gone"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"500dp"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">LinearLayout</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:orientation</span>=<span class="string">"horizontal"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Button</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:id</span>=<span class="string">"@+id/btn_take_pic"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:text</span>=<span class="string">"btn_take_pic"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Button</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:id</span>=<span class="string">"@+id/btn_start_video"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:text</span>=<span class="string">"btn_start_video"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Button</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:id</span>=<span class="string">"@+id/btn_stop_video"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:text</span>=<span class="string">"btn_stop_video"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/04/10/Android/onMeasure()%E5%92%8ConLayout()%E6%80%BB%E7%BB%93/" rel="prev" title="onMeasure()和onLayout()总结">
      <i class="fa fa-chevron-left"></i> onMeasure()和onLayout()总结
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/04/10/Android/Android%E5%A6%82%E4%BD%95%E6%9B%BF%E6%8D%A2%E5%8E%9F%E7%94%9F%E5%BA%94%E7%94%A8/" rel="next" title="Android如何替换原生应用">
      Android如何替换原生应用 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#拍摄照片"><span class="nav-number">1.</span> <span class="nav-text">拍摄照片</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#录制视频"><span class="nav-number">2.</span> <span class="nav-text">录制视频</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#使用surfaceView"><span class="nav-number">2.0.1.</span> <span class="nav-text">使用surfaceView</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用TextureView"><span class="nav-number">2.0.2.</span> <span class="nav-text">使用TextureView</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#相机预览数据的获取"><span class="nav-number">2.0.2.1.</span> <span class="nav-text">相机预览数据的获取</span></a></li></ol></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="CloudLander~Lu"
      src="/images/lu.jpg">
  <p class="site-author-name" itemprop="name">CloudLander~Lu</p>
  <div class="site-description" itemprop="description">记录学习生活，力求每日进步</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">35</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/lujianyun06" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;lujianyun06" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:lujianyun66@163.com" title="E-Mail → mailto:lujianyun66@163.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fas fa-cloud"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">CloudLander~Lu</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
